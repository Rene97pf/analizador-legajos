<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analizador de Legajos</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0f0f23; color: #e8e8e8; font-family: 'Space Grotesk', sans-serif; min-height: 100vh; }
  .mono { font-family: 'DM Mono', monospace; }

  /* Login screen */
  #login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
  #login-box { max-width: 440px; width: 100%; }
  .login-logo { width: 64px; height: 64px; border-radius: 16px; background: linear-gradient(135deg, #4f46e5, #7c3aed); display: inline-flex; align-items: center; justify-content: center; font-size: 28px; margin-bottom: 16px; box-shadow: 0 8px 32px rgba(79,70,229,0.27); }
  .login-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
  .login-sub { color: #888; font-size: 14px; }
  .login-card { background: #1a1a2e; border-radius: 12px; padding: 24px; border: 1px solid rgba(255,255,255,0.05); margin-top: 32px; }
  .login-label { color: #aaa; font-size: 11px; font-family: 'DM Mono', monospace; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px; }
  .login-input { width: 100%; padding: 12px 14px; background: #0f0f23; border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: #e8e8e8; font-size: 14px; font-family: 'DM Mono', monospace; outline: none; }
  .login-input:focus { border-color: #4f46e5; }
  .login-hint { color: #666; font-size: 11px; margin: 8px 0 16px; line-height: 1.4; }
  .login-hint a { color: #7c3aed; text-decoration: none; }
  .btn-primary { width: 100%; padding: 12px; background: linear-gradient(135deg, #4f46e5, #7c3aed); border: none; border-radius: 8px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Space Grotesk', sans-serif; transition: opacity 0.2s; }
  .btn-primary:hover { opacity: 0.9; }
  .btn-primary:disabled { background: #333; cursor: not-allowed; }

  /* App screen */
  #app-screen { display: none; }
  .header { padding: 16px 24px; border-bottom: 1px solid rgba(255,255,255,0.04); display: flex; justify-content: space-between; align-items: center; background: #1a1a2e; }
  .header-left { display: flex; align-items: center; gap: 12px; }
  .header-logo { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #4f46e5, #7c3aed); display: flex; align-items: center; justify-content: center; font-size: 18px; }
  .header-title { font-weight: 700; font-size: 16px; }
  .header-sub { color: #666; font-size: 10px; font-family: 'DM Mono', monospace; }
  .btn-ghost { background: none; border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; color: #888; padding: 6px 12px; font-size: 11px; cursor: pointer; font-family: 'DM Mono', monospace; }
  .btn-ghost:hover { border-color: rgba(255,255,255,0.15); color: #aaa; }

  .main { max-width: 900px; margin: 0 auto; padding: 24px; }

  /* Drop zone */
  .dropzone { border: 2px dashed rgba(255,255,255,0.08); border-radius: 12px; padding: 40px 24px; text-align: center; cursor: pointer; background: #1a1a2e; margin-bottom: 16px; transition: all 0.2s; }
  .dropzone:hover, .dropzone.dragover { border-color: #4f46e5; background: rgba(79,70,229,0.05); }
  .dropzone-icon { font-size: 32px; margin-bottom: 8px; }
  .dropzone-text { font-size: 15px; font-weight: 600; }
  .dropzone-hint { color: #666; font-size: 12px; margin-top: 4px; }

  /* File chips */
  .file-list { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
  .file-chip { background: #1a1a2e; border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; font-size: 12px; }
  .file-chip-name { color: #ccc; font-family: 'DM Mono', monospace; font-size: 11px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .file-chip-remove { color: #666; cursor: pointer; font-size: 14px; line-height: 1; }
  .file-chip-remove:hover { color: #e74c3c; }

  .btn-analyze { margin-top: 4px; padding: 12px 32px; background: linear-gradient(135deg, #4f46e5, #7c3aed); border: none; border-radius: 8px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Space Grotesk', sans-serif; box-shadow: 0 4px 16px rgba(79,70,229,0.27); width: 100%; margin-bottom: 16px; }
  .btn-analyze:hover { opacity: 0.9; }

  /* Progress */
  .progress-box { background: #1a1a2e; border: 1px solid rgba(79,70,229,0.2); border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; }
  .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .progress-label { font-size: 13px; font-weight: 600; }
  .progress-count { color: #7c3aed; font-size: 12px; font-family: 'DM Mono', monospace; }
  .progress-bar-bg { background: #0f0f23; border-radius: 4px; height: 6px; overflow: hidden; }
  .progress-bar { background: linear-gradient(90deg, #4f46e5, #7c3aed); height: 100%; border-radius: 4px; transition: width 0.5s ease; width: 0%; }
  .progress-file { color: #888; font-size: 11px; font-family: 'DM Mono', monospace; margin-top: 6px; }

  /* Stats */
  .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
  .stat-card { background: #1a1a2e; border-radius: 10px; padding: 14px 16px; text-align: center; }
  .stat-value { font-size: 24px; font-weight: 700; font-family: 'DM Mono', monospace; }
  .stat-label { color: #888; font-size: 10px; font-family: 'DM Mono', monospace; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

  /* Result cards */
  .result-card { background: #1a1a2e; border-radius: 12px; margin-bottom: 12px; overflow: hidden; }
  .result-header { padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
  .result-title { font-weight: 700; font-size: 15px; }
  .result-subtitle { color: #888; font-size: 11px; font-family: 'DM Mono', monospace; margin-top: 2px; }
  .result-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
  .result-body { padding: 16px 24px; overflow-x: auto; }
  .result-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .result-table th { color: #888; font-family: 'DM Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
  .result-table td { padding: 10px 8px; font-family: 'DM Mono', monospace; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); }

  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px; font-family: 'DM Mono', monospace; }
  .badge-ok { background: #d1fae5; color: #059669; border: 1.5px solid #059669; }
  .badge-warn { background: #fef3c7; color: #f59e0b; border: 1.5px solid #f59e0b; }
  .badge-error { background: #fee2e2; color: #dc2626; border: 1.5px solid #dc2626; }

  .error-card { background: #1a1a2e; border: 1px solid rgba(231,76,60,0.27); border-radius: 12px; padding: 20px 24px; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
  .error-name { font-weight: 600; font-size: 14px; }
  .error-msg { color: #e74c3c; font-size: 12px; font-family: 'DM Mono', monospace; margin-top: 4px; }

  .btn-new { margin-top: 8px; padding: 10px 24px; background: none; border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: #888; font-size: 13px; cursor: pointer; font-family: 'Space Grotesk', sans-serif; width: 100%; }
  .btn-new:hover { border-color: rgba(255,255,255,0.15); color: #aaa; }

  @media (max-width: 600px) {
    .stats { grid-template-columns: repeat(2, 1fr); }
    .result-table { font-size: 11px; }
  }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div id="login-box">
    <div style="text-align:center">
      <div class="login-logo">üìã</div>
      <h1 class="login-title">Analizador de Legajos</h1>
      <p class="login-sub">Verificaci√≥n autom√°tica de facturas en √≥rdenes de pago</p>
    </div>
    <div class="login-card">
      <label class="login-label">API Key de Google Gemini</label>
      <input type="password" id="apikey-input" class="login-input" placeholder="AIzaSy...">
      <p class="login-hint">Obten√© tu key gratis en <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com</a></p>
      <button class="btn-primary" id="btn-login" disabled>Continuar</button>
    </div>
  </div>
</div>

<!-- APP SCREEN -->
<div id="app-screen">
  <div class="header">
    <div class="header-left">
      <div class="header-logo">üìã</div>
      <div>
        <div class="header-title">Analizador de Legajos</div>
        <div class="header-sub">Verificaci√≥n de facturas</div>
      </div>
    </div>
    <button class="btn-ghost" id="btn-logout">Cambiar API Key</button>
  </div>

  <div class="main">
    <div class="dropzone" id="dropzone">
      <input type="file" id="file-input" multiple accept=".pdf" style="display:none">
      <div class="dropzone-icon">üìÇ</div>
      <div class="dropzone-text">Arrastr√° los legajos PDF ac√°</div>
      <div class="dropzone-hint">o hac√© click para seleccionar archivos</div>
    </div>

    <div id="file-list-container" style="display:none">
      <div class="file-list" id="file-list"></div>
      <button class="btn-analyze" id="btn-analyze" style="display:none">Analizar</button>
    </div>

    <div class="progress-box" id="progress-box" style="display:none">
      <div class="progress-header">
        <span class="progress-label">Procesando...</span>
        <span class="progress-count" id="progress-count">0/0</span>
      </div>
      <div class="progress-bar-bg"><div class="progress-bar" id="progress-bar"></div></div>
      <div class="progress-file" id="progress-file"></div>
    </div>

    <div class="stats" id="stats-container" style="display:none"></div>
    <div id="results-container"></div>
    <button class="btn-new" id="btn-new" style="display:none">Nuevo an√°lisis</button>
  </div>
</div>

<script>
const GEMINI_MODEL = "gemini-2.5-flash-lite";
const SYSTEM_PROMPT = `Eres un auditor contable experto en documentos argentinos.

TAREA: Analizar un legajo de pago PDF que contiene:
1. Una "Orden de Pago a Proveedores" (primera pagina, del sistema dotGestion) con una tabla "CUENTA CORRIENTE DEL PROVEEDOR" que lista facturas con su numero de comprobante original y monto de cancelacion.
2. Facturas reales del proveedor (Facturas tipo B o C emitidas por ARCA/AFIP) que aparecen mas adelante en el PDF. Cada factura real tiene un numero completo con punto de venta y numero de comprobante (formato XXXXX-XXXXXXXX, ejemplo: "0003 - 00001075" o "0006 - 00186027") y un "Total a pagar" o "Total Factura".
3. Otros documentos intermedios como "Recepcion de Factura en Cuenta Corriente" y "Nota de Pedido" que NO debes usar para la comparacion.

INSTRUCCIONES PASO A PASO:
1. Lee la primera pagina y extrae de la tabla "CUENTA CORRIENTE DEL PROVEEDOR" cada fila: el campo "Comprob. Original" (numero de factura del sistema, formato XXXXX-XXXXXXXX) y el campo "Cancelacion" como monto_sistema. MUY IMPORTANTE: La tabla tiene columnas: Aplicacion, Comprob. Original, Cancelacion, Retenciones, Desc/Rec., IMPORTE. DEBES usar "Cancelacion" (monto bruto de la factura), NO "IMPORTE" (que es neto despues de retenciones). Ejemplo: si una fila dice Cancelacion=1.637.445,65 y IMPORTE=1.576.041,44, el monto_sistema debe ser 1637445.65.
2. Para cada factura del sistema, busca en el resto del PDF la factura real ORIGINAL (ignorar DUPLICADO y TRIPLICADO) cuyo numero coincida.
3. De la factura real, extrae el numero COMPLETO incluyendo punto de venta (aparece como "N¬∞: XXXX - XXXXXXXX" en el encabezado de la factura). NUNCA extraigas solo el numero de comprobante sin el punto de venta.
4. Compara numero y monto de cada par.

REGLAS DE COMPARACION:
- NUMEROS: Para comparar, normaliza quitando espacios, guiones y ceros a la izquierda de cada parte. Ejemplo: "00003-00001075" se normaliza a "3-1075", "0003 - 00001075" se normaliza a "3-1075" -> coinciden. Pero "00001075" solo (sin punto de venta) NO coincide con "00003-00001075".
- MONTOS: Convierte ambos a numero decimal. "229.120,00" = 229120.00, "$ 229.120,00" = 229120.00. Si la diferencia absoluta es <= 1.00, marca monto_coincide=true. Si es > 1.00, marca monto_coincide=false.
- Cada factura del sistema debe compararse INDEPENDIENTEMENTE con su factura real correspondiente.
- Si no encuentras la factura real para una factura del sistema, marca factura_real_encontrada=false.

IMPORTANTE SOBRE NUMEROS DE FACTURA REAL: El numero de factura real SIEMPRE tiene dos partes: punto de venta y numero de comprobante, separados por un guion. Ejemplo: "0006-00186027". Buscalo en el encabezado de la factura donde dice "N¬∞:" o "Factura C N¬∞:". NUNCA devuelvas solo el numero de comprobante sin el punto de venta.

RESPUESTA: JSON valido, sin markdown, sin backticks:
{
  "orden_pago": {
    "numero": "91305",
    "proveedor": "NOMBRE DEL PROVEEDOR"
  },
  "comparaciones": [
    {
      "numero_factura_sistema": "00003-00001075",
      "monto_sistema": 1365310.33,
      "numero_factura_real": "00003-00001075",
      "monto_real": 1365310.10,
      "numero_coincide": true,
      "monto_coincide": true,
      "diferencia_monto": 0.23,
      "factura_real_encontrada": true
    }
  ]
}

CRITICO: Analiza cada factura por separado. No marques error en una factura solo porque otra tiene problemas. Se preciso.`;

let apiKey = "";
let files = [];
let results = [];

// DOM refs
const loginScreen = document.getElementById("login-screen");
const appScreen = document.getElementById("app-screen");
const apiKeyInput = document.getElementById("apikey-input");
const btnLogin = document.getElementById("btn-login");
const btnLogout = document.getElementById("btn-logout");
const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("file-input");
const fileListContainer = document.getElementById("file-list-container");
const fileList = document.getElementById("file-list");
const btnAnalyze = document.getElementById("btn-analyze");
const progressBox = document.getElementById("progress-box");
const progressCount = document.getElementById("progress-count");
const progressBar = document.getElementById("progress-bar");
const progressFile = document.getElementById("progress-file");
const statsContainer = document.getElementById("stats-container");
const resultsContainer = document.getElementById("results-container");
const btnNew = document.getElementById("btn-new");

// Events
apiKeyInput.addEventListener("input", () => {
  btnLogin.disabled = apiKeyInput.value.trim().length < 10;
});
apiKeyInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && apiKeyInput.value.trim().length >= 10) login();
});
btnLogin.addEventListener("click", login);
btnLogout.addEventListener("click", logout);
dropzone.addEventListener("click", () => fileInput.click());
dropzone.addEventListener("dragover", (e) => { e.preventDefault(); dropzone.classList.add("dragover"); });
dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
dropzone.addEventListener("drop", (e) => { e.preventDefault(); dropzone.classList.remove("dragover"); addFiles(e.dataTransfer.files); });
fileInput.addEventListener("change", (e) => { addFiles(e.target.files); fileInput.value = ""; });
btnAnalyze.addEventListener("click", processAllFiles);
btnNew.addEventListener("click", resetAnalysis);

function login() {
  apiKey = apiKeyInput.value.trim();
  loginScreen.style.display = "none";
  appScreen.style.display = "block";
}

function logout() {
  apiKey = "";
  apiKeyInput.value = "";
  files = [];
  results = [];
  loginScreen.style.display = "flex";
  appScreen.style.display = "none";
  resetUI();
}

function addFiles(fileListObj) {
  const newFiles = Array.from(fileListObj).filter(f => f.type === "application/pdf");
  files = files.concat(newFiles);
  renderFileList();
}

function removeFile(index) {
  files.splice(index, 1);
  renderFileList();
}

function renderFileList() {
  if (files.length === 0) {
    fileListContainer.style.display = "none";
    return;
  }
  fileListContainer.style.display = "block";
  fileList.innerHTML = files.map((f, i) => 
    '<div class="file-chip">' +
    '<span style="color:#7c3aed">üìÑ</span>' +
    '<span class="file-chip-name">' + escapeHtml(f.name) + '</span>' +
    '<span class="file-chip-remove" onclick="removeFile(' + i + ')">√ó</span>' +
    '</div>'
  ).join("");
  btnAnalyze.style.display = results.length === 0 ? "block" : "none";
  btnAnalyze.textContent = "Analizar " + files.length + " legajo" + (files.length !== 1 ? "s" : "");
}

function escapeHtml(str) {
  return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function formatMoney(amount) {
  if (amount === null || amount === undefined) return "\u2014";
  return new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS" }).format(amount);
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = () => reject(new Error("Error leyendo archivo"));
    reader.readAsDataURL(file);
  });
}

async function callGemini(base64Data) {
  const url = "https://generativelanguage.googleapis.com/v1beta/models/" + GEMINI_MODEL + ":generateContent?key=" + apiKey;
  const response = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      system_instruction: { parts: [{ text: SYSTEM_PROMPT }] },
      contents: [{
        parts: [
          { inlineData: { mimeType: "application/pdf", data: base64Data } },
          { text: "Analiza este legajo de pago completo. Extrae los datos de la Orden de Pago y compara con las facturas reales adjuntas. Responde SOLO con JSON valido." }
        ]
      }],
      generationConfig: { temperature: 0.1, responseMimeType: "application/json" }
    })
  });

  if (!response.ok) {
    const err = await response.text();
    throw new Error("API error " + response.status + ": " + err.substring(0, 200));
  }

  const data = await response.json();
  const text = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text;
  if (!text) throw new Error("Respuesta vac√≠a de Gemini");
  return JSON.parse(text.replace(/```json/g, "").replace(/```/g, "").trim());
}

function normalizeNumForCompare(num) {
  if (!num) return "";
  // Remove spaces, dashes, dots
  var clean = num.replace(/[\s\-\.]/g, "");
  // If it has a clear split point (punto de venta + comprobante), normalize each part
  // Try to split on original dash position
  var parts = num.replace(/\s/g, "").split("-");
  if (parts.length === 2) {
    // Remove leading zeros from each part, but keep at least 1 digit
    var pv = parts[0].replace(/^0+/, "") || "0";
    var comp = parts[1].replace(/^0+/, "") || "0";
    return pv + "-" + comp;
  }
  // No dash found, just return cleaned digits
  return clean.replace(/^0+/, "") || "0";
}

function postValidate(data) {
  if (!data || !data.comparaciones) return data;
  data.comparaciones.forEach(function(comp) {
    if (!comp.factura_real_encontrada) return;
    
    // Re-check number match
    var numSys = normalizeNumForCompare(comp.numero_factura_sistema);
    var numReal = normalizeNumForCompare(comp.numero_factura_real);
    if (numSys !== numReal) {
      comp.numero_coincide = false;
    }
    
    // Re-check amount match
    var montoSys = parseFloat(comp.monto_sistema) || 0;
    var montoReal = parseFloat(comp.monto_real) || 0;
    var diff = Math.abs(montoSys - montoReal);
    comp.diferencia_monto = Math.round(diff * 100) / 100;
    if (diff > 1.0) {
      comp.monto_coincide = false;
    }
  });
  return data;
}

async function processAllFiles() {
  if (files.length === 0) return;
  results = [];
  btnAnalyze.style.display = "none";
  progressBox.style.display = "block";
  statsContainer.style.display = "none";
  resultsContainer.innerHTML = "";
  btnNew.style.display = "none";

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    progressCount.textContent = (i + 1) + "/" + files.length;
    progressBar.style.width = (((i + 1) / files.length) * 100) + "%";
    progressFile.textContent = file.name;

    try {
      const base64 = await fileToBase64(file);
      const data = postValidate(await callGemini(base64));
      results.push({ fileName: file.name, data: data, error: null });
    } catch (err) {
      results.push({ fileName: file.name, data: null, error: err.message });
    }

    renderResults();

    if (i < files.length - 1) {
      await new Promise(r => setTimeout(r, 2500));
    }
  }

  progressBox.style.display = "none";
  renderStats();
  btnNew.style.display = "block";
}

function getStatusInfo(comp) {
  if (!comp.factura_real_encontrada) {
    return { cls: "badge-warn", label: "‚ö†Ô∏è NO ENCONTRADA" };
  }
  var numOk = comp.numero_coincide;
  var montoOk = comp.monto_coincide;
  if (numOk && montoOk) {
    return { cls: "badge-ok", label: "‚úì OK" };
  }
  if (!numOk && !montoOk) {
    return { cls: "badge-error", label: "‚úó N¬∞ Y MONTO" };
  }
  if (!numOk) {
    return { cls: "badge-error", label: "‚úó N¬∞ DIFERENTE" };
  }
  var diff = Math.abs(comp.diferencia_monto || 0);
  if (diff <= 1) return { cls: "badge-warn", label: "~ DIFF $" + diff.toFixed(2) };
  return { cls: "badge-error", label: "‚úó MONTO DIFERENTE" };
}

function getCardColor(comparaciones) {
  if (!comparaciones || comparaciones.length === 0) return { color: "#888", allOk: false, hasWarnings: false };
  const allOk = comparaciones.every(c => c.factura_real_encontrada && c.numero_coincide && c.monto_coincide);
  const hasWarnings = comparaciones.some(c => !c.factura_real_encontrada || (!c.monto_coincide && Math.abs(c.diferencia_monto || 0) <= 1));
  const color = allOk ? "#059669" : hasWarnings ? "#f59e0b" : "#dc2626";
  return { color, allOk, hasWarnings };
}

function renderResults() {
  resultsContainer.innerHTML = results.map(function(r) {
    if (r.error) {
      return '<div class="error-card"><span style="font-size:18px">‚ùå</span><div><div class="error-name">' + escapeHtml(r.fileName) + '</div><div class="error-msg">' + escapeHtml(r.error) + '</div></div></div>';
    }
    if (!r.data) return "";

    const comps = r.data.comparaciones || [];
    const info = getCardColor(comps);
    const icon = info.allOk ? "‚úì" : info.hasWarnings ? "‚ö†" : "‚úó";
    const op = r.data.orden_pago || {};

    let rows = comps.map(function(comp) {
      const st = getStatusInfo(comp);
      const montoRealStr = comp.factura_real_encontrada ? formatMoney(comp.monto_real) : "\u2014";
      const montoRealColor = comp.factura_real_encontrada ? "#e8e8e8" : "#666";
      return '<tr>' +
        '<td style="color:#e8e8e8">' + (comp.numero_factura_sistema || "\u2014") + '</td>' +
        '<td style="color:' + (comp.numero_coincide ? '#e8e8e8' : '#e74c3c') + '">' + (comp.factura_real_encontrada ? (comp.numero_factura_real || "\u2014") : "\u2014") + '</td>' +
        '<td style="text-align:right;color:#e8e8e8">' + formatMoney(comp.monto_sistema) + '</td>' +
        '<td style="text-align:right;color:' + montoRealColor + '">' + montoRealStr + '</td>' +
        '<td style="text-align:center"><span class="badge ' + st.cls + '">' + st.label + '</span></td>' +
        '</tr>';
    }).join("");

    return '<div class="result-card" style="border:1px solid ' + info.color + '33">' +
      '<div class="result-header" style="border-bottom:1px solid ' + info.color + '22;background:' + info.color + '08">' +
        '<div>' +
          '<div class="result-title">OP ' + escapeHtml(op.numero || "?") + ' ‚Äî ' + escapeHtml(op.proveedor || r.fileName) + '</div>' +
          '<div class="result-subtitle">' + escapeHtml(r.fileName) + ' ¬∑ ' + comps.length + ' factura(s)</div>' +
        '</div>' +
        '<div class="result-icon" style="background:' + info.color + '22;border:2px solid ' + info.color + ';color:' + info.color + '">' + icon + '</div>' +
      '</div>' +
      '<div class="result-body">' +
        '<table class="result-table">' +
          '<thead><tr><th style="text-align:left">N¬∞ Fact. Sistema</th><th style="text-align:left">N¬∞ Fact. Real</th><th style="text-align:right">Monto Sistema</th><th style="text-align:right">Monto Real</th><th style="text-align:center">Estado</th></tr></thead>' +
          '<tbody>' + rows + '</tbody>' +
        '</table>' +
      '</div>' +
    '</div>';
  }).join("");
}

function renderStats() {
  let totalFacturas = 0, ok = 0, errors = 0;
  results.forEach(function(r) {
    if (!r.data || !r.data.comparaciones) return;
    r.data.comparaciones.forEach(function(c) {
      totalFacturas++;
      if (c.factura_real_encontrada && c.numero_coincide && c.monto_coincide) ok++;
      else if (c.factura_real_encontrada && (!c.numero_coincide || (!c.monto_coincide && Math.abs(c.diferencia_monto || 0) > 1))) errors++;
    });
  });
  const warnings = totalFacturas - ok - errors;

  statsContainer.style.display = "grid";
  statsContainer.innerHTML = [
    { label: "Legajos", value: results.length, color: "#7c3aed" },
    { label: "OK", value: ok, color: "#059669" },
    { label: "Alertas", value: warnings, color: "#f59e0b" },
    { label: "Errores", value: errors, color: "#dc2626" }
  ].map(function(s) {
    return '<div class="stat-card" style="border:1px solid ' + s.color + '22">' +
      '<div class="stat-value" style="color:' + s.color + '">' + s.value + '</div>' +
      '<div class="stat-label">' + s.label + '</div>' +
    '</div>';
  }).join("");
}

function resetAnalysis() {
  files = [];
  results = [];
  resetUI();
}

function resetUI() {
  fileListContainer.style.display = "none";
  fileList.innerHTML = "";
  btnAnalyze.style.display = "none";
  progressBox.style.display = "none";
  statsContainer.style.display = "none";
  statsContainer.innerHTML = "";
  resultsContainer.innerHTML = "";
  btnNew.style.display = "none";
}
</script>
</body>
</html>
